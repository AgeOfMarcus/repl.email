{% extends "base.html" %} {% block content %}

<!-- INIT -->
<script>
	const user = "{{ user }}";
    const token = "{{ token }}";
    const pfp = "{{ pfp }}";
    const isMobile = '{{ isMobile }}' != 'None';
    var dev_mode = {{ dev_mode }};

    // opt type is the option type for emails e.g. inbox/unread/important etc
    optType = 1;

    // all selected emails ids will be in here
    var selected = [];

    // true if chanegs are made false after refresh
    // refresh can only happen when needChange === true
    needChange = true;
    
    // init value for amount of emails loaded in. will change to length of emails after first refresh
    lastRefresh = 0;
</script>

<!-- youve reached the end animation link -->
<link href='//fonts.googleapis.com/css?family=Dosis:400,600' rel='stylesheet' type='text/css'>
<!-- WEBMAIL STYLESHEET LINK -->
<link rel='stylesheet' href='/static/webmail3111.css'>

<!-- WEBMAIL STYLESHEET -->
<style>
#email-types li, .navbar li {
    -moz-user-select: none;
    -khtml-user-select: none;
    -webkit-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

.all-container {
    height: calc(100vh - 72px) !important;
}

.node a {
    overflow-x: hidden;
}

.email-tab .pin-container {
    width: fit-content;
}
.email-tab {
    width: 125px !important;
}

/* SETTINGS STYLES */
#settings-cont {
    display: none;
    height: 100%;
}
#settings-cont input:focus {
    border-color: #478ed4 !important;
}
.toggle-not-dark {
    background-color: #34323D !important;
}
.heading2 {
    margin: 0 0 .2rem 0 !important;
}
/* /SETTINGS STYLES */
</style>
<!-- WEBMAIL STYLESHEET/ -->

<!-- mobile stylesheet__________________________________ -->
<style>
@media only screen and (max-width: 700px) {
    #rest {
        width: calc(100vw - 5px);
        padding-left: 5px;
    }
    .navbar-container {
        padding: 0 0 0 0 !important;
    }
    .navbar {
        padding-top: 10px;
        background-color: rgb(240, 240, 240);
        position: absolute;
        z-index: 10000;
        width: 100vw !important;
        top: 72px;
        height: calc(100vh - 72px);
        padding: 0 0 0 0 !important;
        max-width: unset !important;
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
    }
    .navbar .nav a {
        display: block;
        margin: auto;
        font-size: 28px;
        height: fit-content;
        position: relative;
    }
    .navbar .nav a i {
        position: absolute;
        left: 15%;
    }

    #search {
        position: absolute;
        top: 77px;
        left: 135px;
        z-index: 1000;
        max-width: calc(100vw - 180px);
        transition: opacity 0.2s ease;
        background-color: rgba(51,51,51,0.3);
    }


    .pin-container label::after {
        display: none !important;
    }
    
    #email-types li label {
        font-size: 12px;
    }

    #movable {
        position: absolute !important;
        width: 100vw !important;
        height: calc(100vh - 72px) !important;
        top: 72px;
        left: 4px;
        border-top-left-radius: 0 !important;
        border-top-right-radius: 0 !important;
        box-shadow: 0 0 0 0 !important;
    }
    #movableheader {
        cursor: default !important;
    }
    #top-nav {
        z-index: 10000;
    }


    .pin-container {
        left: 0 !important;
    }
    .pin-container input[type='checkbox'] + label:before {
        font-size: 18px !important;
    }
    .email-titles {
        display: none !important;
    }
    #opt5-container {
        display: none !important;
    }

    .email-tab .pin-container {
        left: 15px !important;
        top: 45% !important;
    }


    .node a {
        overflow: hidden !important;
        text-overflow: ellipsis;
    }
}
</style>
<!-- /mobile stylesheet__________________________________ -->

<!-- top nav bar -->
<div id='top-nav' class='nav' style='background-color: #333'>
	<div style='display: flex'>
        <!-- LEFT NAV TOGGLE ICON -->
		<a class='nav-btn' onclick='toggleNav()' style='width: fit-content'>
			<i class="fa fa-bars fa-2x"></i>
        </a>

        <div style='display: block; padding: 15px 15px; flex: 2 1 auto'>
            <!-- LOGO -->
            <img class='nav-image' src='./static/mail.png' onclick='window.location.href = "/"' style='width: 35px; height: auto; float: left' />
            <!-- PFP -->
            <div class='nav-image' style='overflow: hidden; border-radius: 50%; width: 35px; height: 35px; margin-left: 15px;  float: left;'>
                <img src='{{ pfp }}' style='width: 35px; height: auto; cursor: pointer' onclick='window.location.href = "https://repl.it/@{{ user }}"'' />
            </div>
            <!-- USERNAME -->
            <div class='username' style='font-weight: bold; color: #4183c4; margin-left: 15px; font-size: 20px; float: left; cursor: pointer'>
                <span onclick='window.location.href = "https://repl.it/@{{ user }}"'>{{ user }}</span>
                <span style='color: grey; cursor: default'> / </span>
                <!-- PAGE (MAIL OR SETTINGS) -->
                <span id='page-name' style='color: #f3f3f3; cursor: default'>Mail</span>
            </div>

            <!-- search bar -->
            <div style='float: left; width: 40%; margin-left: 20px'>
                <input type='search' id='search' style='transition: all 0.5s' placeholder='Search mail' oninput='change()'></input>
            </div>
        </div>
    </div>
</div>

<!-- CONTAINER FOR ALL ELEMENTS (NOT INCLUDING TOP NAV) -->
<div class='all-container'>
    <!-- --------------LEFT NAV--------------- -->
    <div class='navbar-container'>
        <!-- left nav bar -->
        <ul class='navbar' style='display: none'>
            <!-- COMPOSE BUTTON -->
            <li class='nav'><a onclick='newMessage(); hideIfMobile()'><i class="fa fa-plus" style='height: 100%; margin:auto; margin-left: 0; margin-right: 15px'></i> Compose</a></li>
            <!-- SETTINGS BUTTON -->
            <li class='nav'><a id='settings-btn-cont' onclick="load_settings(); hideIfMobile()"><i class="fa fa-cog" style='height: 100%; margin:auto; margin-left: 0; margin-right: 15px'></i> Settings</a></li>
            <!-- LOGOUT BUTTON -->
            <li class='nav'><a href='/logout'><i class="fa fa-sign-out" style='height: 100%; margin:auto; margin-left: 0; margin-right: 15px'></i> Logout</a></li>
            <!-- FEEDBACK BUTTON -->
            <li class='nav'><a href='/app?action=compose&to=MarcusWeinberger@repl.email; rafrafraf@repl.email&subject=Feedback/Suggestion'><i class="fa fa-envelope" style='height: 100%; margin:auto; margin-left: 0; margin-right: 15px'></i> Feedback</a></li>
            <!-- TOGGLE HTML BUTTON -->
            <li id='toggleHTML' class='nav' style='display: none'><a onclick='toggleHTML(); hideIfMobile()'>Toggle HTML/Text</a></li>
        </ul>
    </div>
    <!-- LEFT NAV CSS FOR SCREENS WIDTH <= 700PX -->
    <script>
    if (!window.matchMedia("(max-width: 700px)").matches) {
        $('.navbar').show();
    }
    function hideIfMobile() {
        if (window.matchMedia("(max-width: 700px)").matches) {
            var nav = document.getElementsByClassName("navbar")[0];
            nav.style.opacity = '0';
            nav.style.display = 'none';
        }
    }
    </script>
    <!-- --------------/LEFT NAV--------------- -->
    
    <div id='rest' style='flex: 5 1 auto'>
        <div id='first' class='flexrow'>
            <!-- ----------------LEFTPANE CONTAINER--------------- -->
            <div class='leftpane-container'>
                <!-- settings -->
                <div id='settings-cont'>
                    <div class='container'>
                        <h1>Settings</h1>
                        <br>
                        <!-- FORWARD EMAILS TO SETTING -->
                        <label for='forward'>Forward emails to:</label>
                        <input name='forward' id='forward'>
                        <button onclick='saveForward()' style='background-color: #333; border-color: #334'>Save</button>
                        <br><br>

                        <!-- theme toggle -->
                        <input type="checkbox" id="switch" onclick='saveTheme()' style='visibility: hidden'>
                        <div class="app">
                            <div class="body">
                                <div class="content">
                                    <div class="circle">
                                    <div class="crescent"></div>
                                    </div>
                                    <p class="heading">Choose a display style</p>
                                    <p style='margin-bottom: 12px'>Pop or subtle. Day or night.<br>
                                    Customize your interface
                                    </p>
                                    <label id='toggle-label' for="switch" style='bacground-color: rgba(0,0,0,.1);'>
                                    <div class="toggle toggle-not-dark"></div>
                                    <div class="names">
                                        <p class="light">Light</p>
                                        <p class="dark">Dark</p>
                                    </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- style setting -->
                        <p class="heading heading2">Choose an email style</p>
                        <p style='margin-bottom: 0'>Minimal or complex.<br>
                        Customize your interface
                        </p>
                        <input type="checkbox" id="switch1" onclick='saveStyle()' style='visibility: hidden'>
                        <div class="app">
                            <div class="body">
                                <div class="content">
                                    <label id='toggle-label' for="switch1" style='bacground-color: rgba(0,0,0,.1);'>
                                    <div class="toggle toggle-not-dark"></div>
                                    <div class="names">
                                        <p class="light">Modern</p>
                                        <p class="dark">Classic</p>
                                    </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- date format setting -->
                        <p class="heading heading2">Choose a date format</p>
                        <p style='margin-bottom: 0'>Minimal or complex.<br>
                        Customize your interface
                        </p>
                        <input type="checkbox" id="switch2" onclick='saveDateFormat()' style='visibility: hidden'>
                        <div class="app">
                            <div class="body">
                                <div class="content">
                                    <label id='toggle-label' for="switch2" style='bacground-color: rgba(0,0,0,.1);'>
                                    <div class="toggle toggle-not-dark"></div>
                                    <div class="names">
                                        <p class="light">Simple</p>
                                        <p class="dark">Detailed</p>
                                    </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- API KEY SETTING -->
                        <label for='api_key'><a href='https://pypi.org/project/replemail/'>API Key</a></label>
                        <input name='api_key' id='api_key' value='{{ api_key }}' readonly>
                        <button onclick='newAPIKey()' style='background-color: #333; border-color: #334'>Get a new API Key</button>
                        <div style='height: 200px; background-color: transparent'></div>
                        <!-- QR LOGIN CODE -->
                        <div id='qrcode' style='border: white 2px solid'></div>
                        <div style='height: 200px; background-color: transparent'></div>
                    </div>
                </div> 
                <!-- /settings -->

                <!-- tab thingy -->
                <div class='email-tab'>
                    <div class="pin-container" style='position: relative !important; z-index: 1000'>
                        <!-- SELECT ALL ICON -->
                        <input type="checkbox" id="select-all-checkbox" onclick="checkAll(this.checked)" />
                        <label class='select-email-box' data-title='Select all' for="select-all-checkbox"> </label>

                        <!-- REFRESH ICON -->
                        <input type="checkbox" id="refresh-icon" onclick="refresh()" />
                        <label class='pin-cont-refresh' data-title='Refresh' for="refresh-icon"> </label>

                        <!-- MORE ICON -->
                        <input type="checkbox" id="more-icon"  onclick="" />
                        <label class='pin-cont-more' data-title='More' for="more-icon">
                            <!-- MORE DROPDOWN LIST -->
                            <div class='more-dropdown'>
                                <ul>
                                    <li onclick=''>Mark selected as read</li>
                                    <li onclick='unreadSelected()'>Mark selected as unread</li>
                                    <li>Delete selected messages</li>
                                </ul>
                            </div>
                        </label>
                    </div>
                </div>
                <!-- check if outside of more icon is clicked -->
                <script>
                    $(document).click(function(event) {
                        if ($('#more-icon').is(':checked')) {
                            var $target = $(event.target);
                            if(!$target.closest('.email-tab').length && 
                            $('.more-dropdown').is(":visible")) {
                                $('#more-icon').prop('checked', false);
                            }       
                        }    
                    });
                </script>

                <!-- --------------LEFTPANE--------------- -->
                <div class='leftpane' id='leftpane'>
                    <!-- --------------OPT BUTTONS--------------- -->
                    <div id='email-types-cont' style='width: 100%; height: 50px'>
                        <ul id='email-types'>
                            <!-- INBOX OPT1 -->
                            <li>
                                <input onclick='changeType(1);document.getElementById("search").value = ""' type='radio' id='opt1' name='type-opt' disabled checked>
                                <label for='opt1'>Inbox<span id='inboxCnt' style='color: rgb(181, 181, 181); font-size: 11px;'>( )</span></label>
                            </li>
                            <!-- UNREAD OPT2 -->
                            <li>
                                <input onclick='changeType(2);document.getElementById("search").value = ""' type='radio' id='opt2' name='type-opt' disabled>
                                <label for='opt2'>Unread<span id='unreadCnt' style='color: rgb(181, 181, 181); font-size: 11px;'>( )</span></label>
                            </li>
                            <!-- IMPORTANT OPT5 -->
                            <li id='opt5-container'>
                                <input onclick='changeType(5);document.getElementById("search").value = ""' type='radio' id='opt5' name='type-opt' disabled>
                                <label for='opt5'>Important<span id='importantCnt' style='color: rgb(181, 181, 181); font-size: 11px;'>( )</span></label>
                            </li>
                            <!-- TRASH OPT3 -->
                            <li>
                                <input onclick='changeType(3);document.getElementById("search").value = ""' type='radio' id='opt3' name='type-opt' disabled>
                                <label for='opt3'>Trash<span id='trashCnt' style='color: rgb(181, 181, 181); font-size: 11px;'>( )</span></label>
                                
                            </li>
                            <!-- SENT OPT4 -->
                            <li>
                                <input onclick='changeType(4);document.getElementById("search").value = ""' type='radio' id='opt4' name='type-opt' disabled>
                                <label for='opt4'>Sent<span id='sentCnt' style='color: rgb(181, 181, 181); font-size: 11px;'>( )</span></label>
                            </li>
                        </ul>
                    </div>
                    <!-- --------------/OPT BUTTONS--------------- -->

                    <!-- showed when no messages -->
                    <div id='no-msgs-cont' class='no-msgs' style='display: none'>
                        <!-- LOGO -->
                        <img src='./static/mail.png' style='width: 70%; height: auto;' />
                        <!-- NO MSGS TEXT -->
                        <div>
                            <span id='no-msgs-head' style='font-size: 20px; color: #333'>No messages in your inbox, yet!</span>
                            <br>
                            <span id='no-msgs-body' style='font-size: 14px; color: grey'>Start chatting with coders around you.</span>
                        </div>
                    </div>

                    <!-- email load animation -->
                    <div class="loader" style='display: none'>
                        <div class="reverse-spinner"></div>
                    </div>

                    <!-- all messages -->
                    <ul class='pane' id='messages'></ul>

                    <!-- the end text -->
                    <div id='theEnd' style='display: none; color: #4183c4'></div>

                    <!-- white space -->
                    <div style='background-color: transparent; height: 200px;'>
                    </div>
                </div>
                <!-- --------------/LEFTPANE--------------- -->
            
                <!-- --------------EMAIL PAGE--------------- -->
                <div id='display' style='display: none;'>
                    <!-- PAPER CORNER FOLD (TOP RIGHT) -->
                    <div class="card__corner">
                        <div class="card__corner-triangle"></div>
                    </div>

                    <div style='padding: 15px 15px;'>
                        <!-- BACK BUTTON -->
                        <a style='margin-right: 15px'><i class="fa fa-long-arrow-left fa-2x icon-btn" onclick='closeMessage()'></i></a>

                        <!-- REPLY BUTTON -->
                        <a onclick='replyToMessage()' style='background-color: #333; padding: 5px 12px; border-radius: 15px'><i class='fa fa-reply'></i></a>
                        
                        <!-- DROPDOWN MENU -->
                        <i data-title='More' onclick="toggleEmailDropdown()" class="fa fa-ellipsis-h icon-btn"></i>
                        <div id='email-dropdown-cont' class='more-dropdown' style='left: 120px;'>
                            <ul>
                                <li onclick='replyToMessage()'><i class='fa fa-reply'></i> Reply</li>
                                <li onclick='forwardMessage()'>Forward</li>
                                <li onclick="unreadThis($('#mid')[0].value)">Mark as unread</li>
                                <li class="divider"></li>
                                <li onclick='deleteMessage()' style='color: red !important; font-weight: bold'><i class="fa fa-trash" aria-hidden="true"></i> Delete message</li>
                            </ul>
                        </div>
                        <script>
                            /* When the user clicks on the button, 
                            toggle between hiding and showing the dropdown content */
                            function toggleEmailDropdown() {
                                $('#email-dropdown-cont').toggle()
                            }

                            // Close the dropdown if the user clicks outside of it
                            window.onclick = function(event) {
                                if (!event.target.matches('.icon-btn') && !event.target.matches('#email-dropdown-cont')) {
                                    $('#email-dropdown-cont').hide()
                                }
                            }
                        </script>
                        <!-- /DROPDOWN MENU -->

                        <!-- EMAIL RECIEVED DETAILS -->
                        <label for='from'>From:</label>
                        <input name='from' id='from' readonly><br>
                        <label for='msubject'>Subject:</label>
                        <input name='msubject' id='msubject' readonly><br>
                        <label for='mdate'>Date:</label>
                        <input name='mdate' id='mdate' readonly><br><br>
                        <input id='mid' hidden>

                        <!-- ATTACHMENTS -->
                        <div id='attachments'></div>

                        <!-- EMAIL TEXT -->
                        <div id='mtext' style='width: 90%; height: 100%; overflow-wrap: break-word; display: none'></div>

                        <!-- EMAIL HTML -->
                        <div id='mhtml' style='width: 90%; height: 100%; overflow-wrap: break-word'></div>
                    </div>
                </div>
                <!-- --------------/EMAIL PAGE--------------- -->
            </div>
            <!-- ----------------/LEFTPANE CONTAINER--------------- -->
        </div>
    </div>
</div>

<!-- COMPOSE BOX -->
<div id='movable' style='display: none'>
    <!-- DRAGGABLE TOP -->
    <div id='movableheader' style='width: 100%; height: 40px; background-color: #333; cursor: move; padding: 10px 10px; color: #f3f3f3; font-weight: bold; z-index: 9999; position: relative;'><a style='font-size: 14px; cursor: move;'>New Message</a><a style='position: absolute; right: 10' onclick='hideMessage()'><i class="fa fa-times icon-btn"></i></a></div>
    <!-- COMPOSE BOX INPUTS WRAPPER -->
    <div id='compose-cont' style='padding: 10px 10px; z-index: 9999; position: relative'>
        <div class='ui-widget' id='compose' style='height: 80%'>
            <!-- ----------------TO INPUT BOX ---------------- -->
            <input id="to" type="text" value='' placeholder="Enter something">
            <script>
                var firstElement = document.getElementById('to');
                const choices1 = new Choices(firstElement, {
                    delimiter: ';',
                    editItems: true,
                    addItems: true,
                    removeItems: true,
                    removeItemButton: true,
                    placeholder: true,
                    placeholderValue: 'recipients',
                });
            </script>
            <!-- ----------------/TO INPUT BOX ---------------- -->

            <!-- SUBJECT -->
            <input class='compose-input' placeholder="Subject" name='subject' id='subject' autocomplete="off" >
            <br>
            <!-- PASSWORD -->
            <input class='compose-input' placeholder='Secure email with password (optional)' name='password' id='msg_pass' autocomplete="off">
            <!-- TEXT -->
            <div style='display: flex; flex-direction: column; height: inherit'>
                <!-- TEXT INPUT -->
                <textarea id='body' style='width: 100%; height: 50%; resize: none; border-color: transparent !important;' autocomplete="off"></textarea>
                <!-- TEXT HTML RENDERED -->
                <div id='marked' data-placeholder='Text you type will be rendered as markdown here.' style='width: 100%; height: 50%; overflow-y: scroll; border: 1px solid rgba(129, 132, 166, 0.5)'></div>
            </div>
        </div>

        <div style='height: 20%'>
            <!-- SEND BUTTON -->
            <a class='compose-btn' style='background-color: #333; padding: 5px 12px; border-radius: 10px; float: left' onclick='sendMessage()'>send</a>
            <!-- DISCARD BUTTON -->
            <a style='background-color: transparent; padding: 5px 12px; border-radius: 10px; color: red !important; font-weight: bold; float: left' onclick='hideMessage()'>discard</a>
            <!-- ATTACH FILE BUTTON -->
            <a class='compose-btn' style='background-color: #333; padding: 5px 12px; border-radius: 10px; float: right;' onclick='attatchFile()'>Attatch File</a>
            <br>
        </div>
    </div>
</div>

<!-- BOTTOM MOVING TEXT THINGY -->
<div class='ticker-wrapper'><footer id='status' class='ticker'></footer></div>

<!-- ---------------------BRUH WHAT EVEN IS THIS 
<div class="hover_bkgr_fricc">
    <span class="helper"></span>
    <div>
        <div class="popupCloseButton">&times;</div>
        <div class='flexrow'>
            <div style='float: left; width: 40%' id='editor'>
                <label for='to_'>To:</label>
                <input name='to_' id='to_'><br>
                <label for='subject_'>Subject:</label>
                <input name='subject_' id='subject_'><br>
                <textarea id='body_' placeholder="message body" style='width: 100%'></textarea><br>
            </div>
            <div style='float: right; width: 60%' id='content_'>
            </div>
        </div>
    </div>
</div>
-->

<!-- ----------------------------- SCRIPT START ------------------------------------- -->

<script src='/static/paste.js'></script>
<script src='/static/image.js'></script>
<script src='/static/parser.js'></script>
<script src='https://web.marcusweinberger.repl.co/scripts/qr.js'></script>
<script>

refreshQRCode = () => { new QRCode('qrcode', user + ':' + $('#api_key')[0].value) };
refreshQRCode();

/*
function refreshQRCode() {
    new QRCode("qrcode", {
        text: user + ':' + $('#api_key')[0].value,
        width: 128,
        height: 128,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.H
    });
}
*/

// show settings page
function load_settings() {
    $('#settings-cont').show();
    $('#display').hide();
    $('.email-tab').hide();
    $('.leftpane').hide();
    $('#search').hide();

    $('#settings-btn-cont').attr("onclick","unload_settings(); hideIfMobile()");
    $('#settings-btn-cont').html(`<i class="fa fa-long-arrow-left" style="height: 100%; margin:auto; margin-left: 0; margin-right: 15px"></i> Back`);

    $('#page-name').text('Settings');

    $('.leftpane-container').scrollTop(0);
}
// hide settings page
function unload_settings() {
    $('#settings-cont').hide();
    $('.email-tab').show();
    $('.leftpane').show();
    $('#no-msgs-cont').hide();
    $('#search').show();

    $('#settings-btn-cont').attr("onclick","load_settings(); hideIfMobile()");
    $('#settings-btn-cont').html(`<i class="fa fa-cog" style="height: 100%; margin:auto; margin-left: 0; margin-right: 15px"></i> Settings`);

    $('#page-name').text('Mail');

    $('.leftpane-container').scrollTop(0);
}

// event listener for leftpane container scroll
firstTime = true
jQuery(function($) {
    $('.leftpane-container').on('scroll', function() {
        // show youve reached the end text when u scroll to bottom of leftpane container (only the first time)
        if (!$('.loader').is(':visible') && firstTime) {
            if ($(this).scrollTop() + $(this).innerHeight() + 100 >= $(this)[0].scrollHeight) {
                $('#theEnd').css('display', 'block');
                play();
                firstTime = false;
            }    
        }
        // hide/show search bar depending on when it should be visible
        if ($('.leftpane').is(':visible')) {
            if ($(this).scrollTop() === 0) {
                $('#search')[0].style.display = 'block';
                setTimeout(function() {
                    $('#search')[0].style.opacity = '1';
                }, 10)
            }
            else {
                $('#search')[0].style.display = 'none';
                $('#search')[0].style.opacity = '0';
            }
        }
    })
});
// /event listener for leftpane container scroll

// animation for youve reached the end text
function play() {
    setTimeout( function() {
        var l = $('#theEnd');
        // modify this one line below, and see the result !
        var logoTitle = "You've reached the end.";
        var logoRandom = '';
        var possible = "-+*/|}{[]~\\\":;?/.><=+-_)(*&^%$#@!)}";
        function generateRandomTitle(i, logoRandom) {
            setTimeout( function() {
                l.text(logoRandom);
            }, i*70 );
        }
        for( var i=0; i < logoTitle.length+1; i++ ) {
            logoRandom = logoTitle.substr(0, i);
            for( var j=i; j < logoTitle.length; j++ ) { 
                logoRandom += possible.charAt(Math.floor(Math.random() * possible.length)); 
            }
            generateRandomTitle(i, logoRandom);
            logoRandom = '';
        }
    }, 250 );
}
// /animation for youve reached the end text

//----- compose box dragging script
if (!window.matchMedia("(max-width: 700px)").matches) {
    dragElement(document.getElementById("movable"));
}
function dragElement(elmnt) {
    var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    if (document.getElementById(elmnt.id + "header")) {
        /* if present, the header is where you move the DIV from:*/
        document.getElementById(elmnt.id + "header").onmousedown = dragMouseDown;
    } else {
        /* otherwise, move the DIV from anywhere inside the DIV:*/
        elmnt.onmousedown = dragMouseDown;
    }
    function dragMouseDown(e) {
        e = e || window.event;
        e.preventDefault();
        // get the mouse cursor position at startup:
        pos3 = e.clientX;
        pos4 = e.clientY;
        document.onmouseup = closeDragElement;
        // call a function whenever the cursor moves:
        document.onmousemove = elementDrag;
    }
    function elementDrag(e) {
        e = e || window.event;
        e.preventDefault();
        // calculate the new cursor position:
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        // set the element's new position:
        elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
        elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
    }
    function closeDragElement() {
        /* stop moving when mouse button is released:*/
        document.onmouseup = null;
        document.onmousemove = null;
    }
}
//----- /compose box dragging script

//----- search bar script
function search() {
    var input = document.getElementById('search');
    filter = input.value.toUpperCase();

    $('li','#messages').each(function() {
        // inbox
        if (optType === 1) {
            if (!$(this).attr('class').includes('DELETED')) {
                if ($(this).text().toUpperCase().indexOf(filter) > -1) {
                    $(this).css("display", "block");
                }
                else {
                    $(this).css("display", "none");
                }
            }
        }
        // UNREAD
        if (optType === 2) {
            if (!$(this).attr('class').includes('Read')) {
                if ($(this).text().toUpperCase().indexOf(filter) > -1) {
                    $(this).css("display", "block");
                }
                else {
                    $(this).css("display", "none");
                }
            }
            if ($(this).attr('class').includes('DELETED')) {
                $(this).css("display", "none");
            }
        }
        // DELETED
        if (optType === 3) {
            if ($(this).attr('class').includes('DELETED')) {
                if ($(this).text().toUpperCase().indexOf(filter) > -1) {
                    $(this).css("display", "block");
                }
                else {
                    $(this).css("display", "none");
                }
            }
        }
        // Important
        if (optType === 5) {
            if ($(this).attr('class').includes('Important')) {
                if ($(this).text().toUpperCase().indexOf(filter) > -1) {
                    $(this).css("display", "block");
                }
                else {
                    $(this).css("display", "none");
                }
            }
            if ($(this).attr('class').includes('DELETED')) {
                $(this).css("display", "none");
            }
        }
        // sent
        if (optType === 4) {
        
        }
    })

    areHidden();
}
var timer;
function change(type){
    clearTimeout(timer);
    timer = setTimeout(search, 500);
}
//------ /search bar script


$(function() {
    $.get('https://notes.marcusj.tech/link/status.repl.email?render=false', (c) => {
        $('#status').html(c);
    })
})

var pastes = [];
var pfps = {};
var theme = "{{ theme }}";
var emails_by_flag = {};

function htmlsafe(html) {
    return sanitizeHtml(html, {
        allowedTags: sanitizeHtml.defaults.allowedTags.concat([ 'img', 'h1', 'div', 'iframe', 'span' ]),
        allowedAttributes: {
            a: ['href', 'name', 'target', 'id'],
            img: ['src'],
            span: ['id'],
            iframe: ['src', 'height', 'width', 'scrolling', 'frameborder', 'allowtransparency', 'allowfullscreen', 'sandbox'],
        },
    });
}

function api(uri, data, callback) {
    $.ajax({
        url: '/api' + uri,
        type: 'post',
        data: JSON.stringify(data),
        headers: {
            token: token,
        },
        contentType: 'application/json',
        success: callback
    })
}

$( function() { //---------"WHAT DIS DO LMAO" -rafrafraf
    api('/contacts', {}, (res) => {
        $('#to').autocomplete({
            source: res['contacts']
        })
    })
})

function get_by_flag(flag, num=-1) { // ---WHEN DO WE EVEN USE DIS LOL
    api('/get/by/flag', {
        'flag': flag,
        'num': num,
    }, (res) => {
        globalThis.emails_by_flag[flag] = res;
    })
}

function delete_forever(id) { //-----------NOT IMPLEMENTED I THINK
    api('/delete/forever', {'id':id}, (res) => {
        $.notify('Deleted', 'success');
    })
}

function get_sent() { // ---------------------DONT WORK
    api('/sent', {}, (res) => {
        globalThis.sent_emails = res;
    })
}

function set_flags_dict(dict, notif=true) { // ---------DOESNT WORK
    api('/flag', dict, (res) => {
        if (notif) {
            $.notify('Updated', 'success');
        }
        console.log(res)
    })

    needChange = true;
}
 
function set_flags(ids, flags, notif=true) {
    var d = {};

    d[ids] = flags;
    
    console.log(d)
    api('/flag', d, (res) => {
        if (notif) {
            $.notify('Updated', 'success')
        }
        console.log(res)
    })

    needChange = true;
}

function get_profile(username) {
    if (username in pfps) {
        return pfps[username];
    } else {
        api('/profile', {'username': username}, (res) => {
            pfps[username] = res['url'];
        })
    }
}

// counts number of emails in each opt type, then displays number on opt buttons
function countEmails() {
    // inbox
    $('#inboxCnt').text(`(${$('#messages li:not(.DELETED)').length})`);
    // unread
    $('#unreadCnt').text(`(${$('#messages li:not(.DELETED) i.fa-circle:visible').length})`);
    // important
    $('#importantCnt').text(`(${$('#messages li.Important').length})`);
    // trash
    $('#trashCnt').text(`(${$('#messages li.DELETED').length})`);
}

// shows/hides emails in pane based on optType 
function changeType(to=optType) { // called when opt button pressed
    optType = to;
    countEmails();
    $('#theEnd').css('display', 'none');

    $('li','#messages').each(function() {
        // inbox
        if (optType === 1) {
            if ($(this).attr('class').includes('DELETED')) {
                $(this).css("display", "none");
            }
            else {
                $(this).css("display", "block");
            }
        }
        // UNREAD
        if (optType === 2) {
            if ($(this).attr('class').includes('Read')) {
                $(this).css("display", "none");
            }
            else {
                $(this).css("display", "block");
            }
            if ($(this).attr('class').includes('DELETED')) {
                $(this).css("display", "none");
            }
        }
        // DELETED
        if (optType === 3) {
            if (!$(this).attr('class').includes('DELETED')) {
                $(this).css("display", "none");
            }
            else {
                $(this).css("display", "block");
            }
        }
        // Important
        if (optType === 5) {
            if (!$(this).attr('class').includes('Important')) {
                $(this).css("display", "none");
            }
            else {
                $(this).css("display", "block");
            }
            if ($(this).attr('class').includes('DELETED')) {
                $(this).css("display", "none");
            }
        }
        // sent
        if (optType === 4) {
            
        }
    });

    areHidden();
    $('.loader').hide();
}

// checks if any emails are visible, if not show no messages thingy
function areHidden() {
    if ($('#messages').children(':visible').length === 0) {
        if (!$('.loader').is(':visible')) {
            $('#no-msgs-cont').css('display','block');
        }
    }
    else {
        $('#no-msgs-cont').css('display','none');
    }
    pinToTop();
}

function togglePin(id, checked, flags) {
    if (!flags.includes('DELETED')) {
        if (checked) {
            if (!flags.includes('PINNED')) {
                flags.push('PINNED');
            }
            
            set_flags(parseInt(id), flags);

            $(`${id}li`).addClass('PINNED');
        }
        else {
            if (flags.includes('PINNED')) {
                flags.splice(flags.indexOf('PINNED'), 1);
            }

            set_flags(parseInt(id), flags);

            $(`${id}li`).removeClass('PINNED');
        }    
    }
}

function toggleImportant(id, checked) {
    var newid = id.replace(/f/g, '');
    var flags = emails[newid]['flags'];
    if (!flags.includes('DELETED')) {
        if (checked) {
            if (!flags.includes('Important')) {
                flags.push('Important');
            }
            
            set_flags(parseInt(newid), flags);

            $(`#${newid}li`).addClass('Important');
        }
        else {
            if (flags.includes('Important')) {
                flags.splice(flags.indexOf('Important'), 1);
            }

            set_flags(parseInt(newid), flags);

            $(`#${newid}li`).removeClass('Important');
        }    
    }
}

// places pinned emails to top of messages
function pinToTop() {
    var firstGo = true;

    var last = '#messages li:first-child';
    $('#messages').children().each(function () {
        if ($(this).hasClass('PINNED')) {
            if (firstGo) {
                $(this).remove().insertBefore($(last));
                firstGo = false;
            }
            else {
                $(this).remove().insertAfter($(last));
            }
            last = this;
        }
    });
}

// read email (single) P.S. called when opening email
function readThis(id, flags, notif=true) { // marks email as read
    if (!flags.includes('DELETED')) {
        if (!flags.includes('Read')) {
            flags.push('READ');
        }
        
        set_flags(parseInt(id), flags, notif);

        $(`#${id}circle`).hide();
    }
}

function readAllSelected() { // --------------------UNFINISHED

}

// unread email (single)
function unreadThis(id, notif=true) {
    var currentflags = globalThis.emails[id]['flags'];
    console.log(id, currentflags)

    if (!currentflags.includes('DELETED')) {
        if (currentflags.includes('Read')) {
            currentflags.splice(currentflags.indexOf('Read'), 1);
        }
        
        set_flags(parseInt(id), currentflags, notif);

        $(`#${id}circle`).show();

        $(`#${id}li`).removeClass('Read');
    }
}

function unreadSelected() { // --------------------UNFINISHED
    //if (selected.length > 0) {
        //var dict1 = {};
        //for (x=0; x<selected.length; x++) {
            //dict1[selected[x]] = globalThis.emails[selected[x]]['flags'];
            //$(`#${selected[x]}circle`).show();

            //$(`#${selected[x]}li`).removeClass('Read');
        //}
        //console.log(dict1);

        //set_flags_dict(dict1);    
    //}
}

// select/unselect email element
function selectThisEmail(id, checked) {
    var newid = id.replace(/c/g, '');

    if (checked) {
        $(`#${newid}li`).addClass('selected');

        selected.push(parseInt(newid));
    }
    else {
        $(`#${newid}li`).removeClass('selected');

        selected = selected.filter(function(e) { return e !== newid })
    }
}

// select/unselect all email elements
function checkAll(checked) {
    $('.select-email-box-input','.pin-container').each(function() {
        if ($(this).parent().is(':visible')) {
            $(this).prop('checked', checked);
            selectThisEmail($(this).attr('id'), checked);
        }
    })
}

function makeEmails(emails, show_gif=true) {
    //console.log(lastRefresh, Object.keys(emails).length, lastRefresh === Object.keys(emails).length)
    if (lastRefresh !== Object.keys(emails).length || needChange) {

        // fragments will make the append dom elements more efficient as u only append it once to the parent
        // instead of appending each child to the parent.
        var fragment = $(document.createDocumentFragment());

        needChange = false;
        document.getElementById('messages').innerHTML = '';

        if (show_gif) {
            document.getElementsByClassName('loader')[0].style.display = 'none';
        }

        globalThis.emails = emails;

        var t0 = performance.now();

        var count = 0;
        for (id in emails) {
            //console.log(emails[id]['flags'], id)
            //if (emails[id]['flags'].includes('Deleted')) {
                //api('/delete', {'id':id}, (res) => {
                    //$.notify('DELETED', 'info');
                //})
            //}
            
            // check if email id returns a valid value before making email element
            var goAhead = false;
            try {
                emails[id]['flags'].includes('read');

                goAhead = true;
            }
            catch(err) {
                console.log(`email with id:${id} is invalid.`);
            }

            if (goAhead) {
                var allFlags = emails[id]['flags'];

                // simple and detailed date script
                var temp = emails[id]['date'].split(/[ ,]+/);
                modernDate = `${temp[2]} ${temp[1]}, ${temp[3]}T${temp[4]}`;
                modernDate = moment(modernDate, 'lll').fromNow();
                if (getSetting('dateFormat').includes('detailed')) {
                    var mo1 = 'display: none';
                    var mo2 = '';
                } 
                else {
                    var mo2 = 'display: none';
                    var mo1 = '';
                }

                // read/unread
                var tmpflag = '';
                for (i in allFlags) {
                    tmpflag += "'" + allFlags[i] + "',";
                }
                var onclickRead = `readThis(${id}, [${tmpflag}])`;
                var read = `<i id="${id}circle" class="fa fa-circle"></i>`;
                if (allFlags.includes('Read')) {
                    //onclickRead = '';
                    read = `<i id="${id}circle" class="fa fa-circle" style='display: none'></i>`;
                }

                // Important
                var imp = '';
                if (allFlags.includes('Important')) {
                    imp = 'checked';
                }

                // pin
                var div = document.createElement("li");
                div.id = `${id}li`;
                div.className = `node ${allFlags.join(' ')}`;
                div.style.display = 'none';

                if (allFlags.includes('PINNED')) { // PINNED
                    div.innerHTML = `
                    ${read}
                    <div class="pin-container">
                        <input type="checkbox" id="${id}c" name="favourite${id}" onclick="selectThisEmail(this.id,this.checked)" class='select-email-box-input' />
                        <label class='select-email-box' data-title='Select' for="${id}c"> </label>

                        <input type="checkbox" id="${id}" name="check${id}" onclick="togglePin(this.id,this.checked, emails[id]['flags'])" checked/>
                        <label data-title='Pin' for="${id}"> </label>

                        <input type="checkbox" id="${id}f" name="favourite${id}" onclick="toggleImportant(this.id,this.checked)" ${imp}/>
                        <label class='important' data-title='Important' for="${id}f"> </label>
                    </div>
                    `;
                }
                // not PINNED
                else { 
                    div.innerHTML = `
                    ${read}
                    <div class="pin-container">
                        <input type="checkbox" id="${id}c" name="favourite${id}" onclick="selectThisEmail(this.id,this.checked)" class='select-email-box-input' />
                        <label class='select-email-box' data-title='Select' for="${id}c"> </label>

                        <input type="checkbox" id="${id}" name="check${id}" onclick="togglePin(this.id,this.checked, emails[id]['flags'])" />
                        <label data-title='Pin' for="${id}"> </label>

                        <input type="checkbox" id="${id}f" name="favourite${id}" onclick="toggleImportant(this.id,this.checked)" ${imp}/>
                        <label class='important' data-title='Important' for="${id}f"> </label>
                    </div>
                    `
                }       

                // CLASSIC STYLE
                if (getSetting('style').includes('classic')) {
                    div.innerHTML += `
                    <a class="" style='padding: 8px 15px 8px 100px !important' onclick="openMessage(${id.toString()});${onclickRead}">
                        <span class='email-titles'>From: </span>${emails[id]['from'].split('<').join('').split('>').join('')}
                        <br>
                        <span class='email-titles'>Subject: </span>${emails[id]['subject']}
                        <br>
                        <span class='email-titles'>Date: </span><span class='date simple-date' style='${mo1}'>${modernDate}</span><span class='date detailed-date' style='${mo2}'>${emails[id]['date']}</span>
                    </a>`; // havent tested dis yet
                }

                // MODERN STYLE
                if (getSetting('style').includes('modern')) {
                    div.innerHTML += `
                    <a class="modern-email" onclick="openMessage(${id.toString()});${onclickRead}">
                        <div class='modern-cont'>
                            <span class='modern-subject'>
                                ${emails[id]['subject']}
                            </span>
                            <span class='modern-date'>
                                <span class='simple-date' style='${mo1}'>${modernDate}</span>
                                <span class='detailed-date' style='${mo2}'>${emails[id]['date']}</span>
                            </span>
                        </div>
                        
                        <div class='modern-name'>
                            ${emails[id]['from'].split('<').join('').split('>').join('')}
                        </div>
                    </a>`
                }

            }
            count++;

            // prepend email li to fragment
            fragment.prepend(div);

            // run this on last iteration
            if (Object.keys(emails).length === count) {
                // put fragment into messages on final iteration
                $("#messages").append(fragment)

                console.log("Call to refresh took " + ((performance.now() - t0) / 1000) + " seconds.")
                changeType();
            }
        }
    }
}

// get request for emails(messages) and call to makeEmails func
function refresh(show_gif=true, num=-1) {
    if (lastRefresh === 0) {
        $('.loader').show();
    }
    // set refresh checkbox to true while loading emails
    $('#refresh-icon').prop('checked', true);

    var tm1 = performance.now();
    api('/get', {'num': num}, (emails) => {
        makeEmails(emails, show_gif);

        console.log("Emails request took " + ((performance.now() - tm1) / 1000) + " seconds.")
        $.notify('Refreshed', 'info');  

        // lastrefresh is length of emails from most recent get request
        lastRefresh = Object.keys(emails).length;

        // uncheck refresh checkbox once emails loaded and made
        $('#refresh-icon').prop('checked', false);
        
        // enable opt buttons after emails loaded and made
        $('#opt1').removeAttr("disabled");
        $('#opt2').removeAttr("disabled");
        $('#opt3').removeAttr("disabled");
        $('#opt5').removeAttr("disabled");
    })
}

// hide opened message recieved
function closeMessage() {
    $('.leftpane')[0].style = 'display: block';
    $('#display')[0].style = 'display: none';
    $('.email-tab')[0].style = 'display: block';

    $('#search').show();

    $('#toggleHTML')[0].style = 'display: none';

    areHidden();
}

function get_attatchments(id) {
    var ats = {};
    var keys = Object.keys(emails[id]);
    for (i in keys) {
        var key = keys[i];
        if (!(['from', 'subject', 'to', 'date', 'html', 'text', 'flags'].includes(key))) {
            ats[key] = emails[id][key];
        }
    }
    return ats;
}

function openBase64InNewTab (data, mimeType) {
    var byteCharacters = atob(data);
    var byteNumbers = new Array(byteCharacters.length);
    for (var i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
    }
    var byteArray = new Uint8Array(byteNumbers);
    var file = new Blob([byteArray], { type: mimeType + ';base64' });
    var fileURL = URL.createObjectURL(file);
    window.open(fileURL);
}
function redirectOpenFile(id, cnt, ft) {
    var ats = get_attatchments(id);
    var count = 0;
    for (ft in ats) {
        console.log(cnt, count, cnt===count, cnt==count)
        if (cnt === count) {
            openBase64InNewTab(ats[ft], ft);
            console.log(ats[ft], ft)
        }
        
        count++;
    }
}
function openAttatchment(id, i) {
    var a = emails[id]['files'][i];
    openBase64InNewTab(a['data'], a['filetype']);
}

function openMessage(id) {
    $('#attachments').empty();
    $('.email-tab')[0].style = 'display: none';
    $('#search').hide();

    $('.leftpane')[0].style = 'display: none';
    $('#display')[0].style = 'display: block';

    email = globalThis.emails[id];

    $('#toggleHTML')[0].style = '';

    $('#from')[0].value = email['from'];
    $('#msubject')[0].value = email['subject'];
    $('#mdate')[0].value = email['date'];

    $('#mtext')[0].innerHTML = htmlsafe(email['text']);

    if (globalThis.dev_mode) {
        $('#mhtml').append($('<iframe></iframe>').attr('src', 'data:text/html;charset=utf-8,' + email['html']));
    } else {
        $('#mhtml')[0].innerHTML = htmlsafe(email['html']);
    }

    var ats = emails[id]['files'];
    for (i in ats) {
        $('#attachments').append(`
        <div class='attachment-item' id='${id}' onclick="openAttatchment('${id}', ${i})">
            <i style='color: rgb(214, 153, 30)' class="fa fa-file fa-2x"></i>
            <span style='margin-left: 5px;'> ${ats[i]['filename']}</span>
            <i class="fa fa-external-link icon-btn"></i>
        </div>
        `);
    }

    /*/ add attachments
    var ats = emails[id]['files'];
    var cnt = 0;
    for (ft in ats) {
        $('#attachments').append(`
        <div class='attachment-item' id='${id}' onclick="redirectOpenFile(${id}, ${cnt}, '${ft["filetype"]}')">
            <i style='color: rgb(214, 153, 30)' class="fa fa-file fa-2x"></i>
            <span style='margin-left: 5px;'> ${ft["filename"]}</span>
            <i class="fa fa-external-link icon-btn"></i>
        </div>
        `);
        
        cnt++;
    }*/

    var pastelink =  $('#mhtml').find('#paste');
    if (pastelink.length > 0) {
        var i = pastes.push(pastelink[0].innerText) - 1;
        pastelink.on('click', function(e) {
            var uid = pastes[i];
            var pwd = prompt('Password');

            get_paste(uid, pwd, (res) => {
                $('#mtext')[0].innerHTML = htmlsafe(res['res']);
                globalThis.emails[id]['text'] = res['res'];
                toggleHTML();
            })
        }).removeAttr('href').text(' Password Protected Content ');
    }

    $('#mid')[0].value = id;

    $('#display')[0].style = '';

    if (email['from'].endsWith('@repl.email')) {
        var uname = email['from'].split('@repl.email')[0];
        $('#from')[0].style['cursor'] = 'pointer';
        $('#from').on('click', function() {
            window.location.href = 'https://repl.it/@' + uname;
        })
    }
}

function forwardMessage() {
    var id = $('#mid')[0].value;
    var prev = globalThis.emails[id];
    newMessage();
    choices1.clearStore();
    
    $('#subject')[0].value = 'FW: ' + prev['subject'];
    $('#body')[0].value = `\n\n\n----------\nOriginal from: ${prev['from']}<br><br><blockquote>${prev['text']}</blockquote>`
    $('#marked').html(htmlsafe(marked($('#body')[0].value)));
}

function replyToMessage() {
    var id = $('#mid')[0].value;
    var prev = globalThis.emails[id];
    newMessage();
    choices1.clearStore();
    var tmp = `${prev['from']}`;
    choices1.setValue(
        [{ value: tmp, label: tmp }],
        replaceChoices=true)
    
    if (prev['subject'].startsWith('RE: ')) {
        $('#subject')[0].value = prev['subject'];
    } else {
        $('#subject')[0].value = 'RE: ' + prev['subject'];
    }

    $('#body')[0].value = `\n\n\n----------\nReplying to: ${prev['from']}<br><br><blockquote>${prev['text']}</blockquote>`
    $('#marked').html(htmlsafe(marked($('#body')[0].value)));
}

// show and init compose box
function newMessage() {
    $('#movable')[0].style = 'display: block';
    choices1.clearStore();
    $('#to').val('');
    $('#subject')[0].value = '';
    $('#body')[0].value = '';
    $('#msg_pass')[0].value = '';
    $('#marked')[0].innerHTML = '';
}

// hide compose box
function hideMessage() {
    $('#movable')[0].style = 'display: none';
}

function sendMessage() {
    var to = $('#to')[0].value;
    var subj = $('#subject')[0].value;
    var body = parse($('#body')[0].value);
    var mpass = $('#msg_pass')[0].value;
    
    if (mpass !== '') {
        create_paste(body, mpass, (res) => {
            var uid = res['res'];
            api('/send', {
                'to': to.split('; '),
                'subject': subj,
                'text': 'https://paste.marcusj.tech/view/' + uid,
                'html': '<a id="paste" href="https://paste.marcusj.tech/view/' + uid + '">' + uid + '</a>',
            }, (r) => {
                if (r['data']['failed'] == 0) {
                    $.notify('Sent', 'success');
                    console.log(r);
                    hideMessage();
                } else {
                    $.notify('Error, could not send', 'error');
                    console.log(r);
                }
            });
        })
    } else {
        api('/send', {
            'to': to.split('; '),
            'subject': subj,
            'text': body,
            'html': marked(body),
        }, (r) => {
            if (r['data']['failed'] == 0) {
                $.notify('Sent', 'success');
                console.log(r);
                hideMessage();
            } else {
                $.notify('Error, could not send', 'error');
                console.log(r);
            }
        })
    }

}

function discardMessage() {
    fields = ['subject', 'body', 'msg_pass'];
    for (i in fields) {
        $('#' + fields[i])[0].value = '';
    }

    $('#from').off('click');
    $('#from')[0].style['cursor'] = '';
    choices1.clearStore();
    $('#marked')[0].innerHTML = '';
}

function toggleHTML() {
    if ($('#mtext:hidden').length == 0) {
        $('#mtext')[0].style = 'width: 100%; height: 100%; overflow-wrap: break-word; display: none';
        $('#mhtml')[0].style = 'width: 100%; height: 100%; overflow-wrap: break-word';
    } else {
        $('#mtext')[0].style = 'width: 100%; height: 100%; overflow-wrap: break-word';
        $('#mhtml')[0].style = 'width: 100%; height: 100%; overflow-wrap: break-word; display: none';
    }
}

function attatchFile() {
    var input = $(document.createElement('input')).attr('type', 'file');
    input.click();

    input.on('change', function() {
        console.log('attatchForm onchange'); //debug
        if (!(input[0].files.length == 0)) {
            var reader = new FileReader();

            /*
            reader.readAsDataURL(input[0].files[0])
            reader.onloadend = function() {
                editor.insert(`<a href="${reader.result}">${input[0].files[0].name}</a>`);
            } */

            reader.readAsBinaryString(input[0].files[0]);
            reader.onloadend = function() {
                api('/upload', {'data': btoa(reader.result), 'filename': input[0].files[0].name}, (url) => {
                    console.log('uploaded:', url) //debug
                    editor.insert(`<a href="${url['url']}">${input[0].files[0].name}</a>`);
                })
            } 
        }
    })
}

function deleteMessage() {
    var id = $('#mid')[0].value;

    if (id) {
        api('/delete', {'id':id}, (res) => {
            $.notify('DELETED', 'info');
            closeMessage();
            refresh();
        })
    }

    $('#mid')[0].value = '';

    selectedEmails();

    needChange = true;
}

// refresh emails interval
setInterval(function() {
    refresh(show_gif=false);
}, 60 * 1000) // every minute

/*
// popup editor
$(window).on('load', function () {
    $("#trigger_popup").click(function(){
       $('.hover_bkgr_fricc').show();
    });
    $('.popupCloseButton').click(function(){
        $('.hover_bkgr_fricc').hide();
    });
});

$('#body_').bind('input propertychange', function() {
    $('#content_')[0].innerHTML = marked($('#body_')[0].value);
})
*/

// https://stackoverflow.com/a/11077016
function insertAtCursor(myField, myValue) {
    //IE support
    if (document.selection) {
        myField.focus();
        sel = document.selection.createRange();
        sel.text = myValue;
    }
    //MOZILLA and others
    else if (myField.selectionStart || myField.selectionStart == '0') {
        var startPos = myField.selectionStart;
        var endPos = myField.selectionEnd;
        myField.value = myField.value.substring(0, startPos)
            + myValue
            + myField.value.substring(endPos, myField.value.length);
    } else {
        myField.value += myValue;
    }
} // -https://stackoverflow.com/a/11077016

var editor = {
    'italics': function() {
        var e = $('#body')[0];
        var s = e.selectionStart;
        e.value = e.value.substring(0, s) + '**';
        e.value.substring(e.selectionEnd);
        e.selectionEnd = s + 1;
    },
    'bold': function() {
        var e = $('#body')[0];
        var s = e.selectionStart;
        e.value = e.value.substring(0, s) + '****';
        e.value.substring(e.selectionEnd);
        e.selectionEnd = s + 2;
    },

    'insert': function(text) {
        insertAtCursor($('#body')[0], text);
    },
}

shortcut.add('ctrl+b', () => { editor.bold() });
shortcut.add('ctrl+i', () => { editor.italics() })

var textareas = document.getElementsByTagName('textarea');
var count = textareas.length;
for(var i=0;i<count;i++){
    textareas[i].onkeydown = function(e){
        if(e.keyCode==9 || e.which==9){
            e.preventDefault();
            var s = this.selectionStart;
            this.value = this.value.substring(0,this.selectionStart) + "    " + this.value.substring(this.selectionEnd);
            this.selectionEnd = s+4; 
        }
    }
}

$('#body')[0].addEventListener('paste', (event) => {
    var items = event.clipboardData.items;
    for (i in items) {
        var item = items[i];
        if (item.type == 'text/plain') {
            var text = item.clipboardData.getData('text/plain');
            if (text.startsWith('https://repl.it/@')) {
                var embed_code = '<iframe height="400px" width="100%" src="' + text + '?lite=true" scrolling="no" frameborder="no" allowtransparency="true" allowfullscreen="true" sandbox="allow-forms allow-pointer-lock allow-popups allow-same-origin allow-scripts allow-modals"></iframe>';
                $('#body')[0].value += embed_code;
            } else {
                continue;
            }
        }
        if (item.type.indexOf('image') == -1) continue;
        upload_image(item.getAsFile(), (url) => {
            $('#body')[0].value += '<img src="' + url + '/.png">';
        })
    }
}, false)

$('#body').on('input propertychange', (e) => {
    $('#marked').html(htmlsafe(marked($('#body')[0].value)));
})

shortcut.add('ctrl+enter', sendMessage);
shortcut.add('ctrl+n', newMessage);

refresh(); // initial get emails 

if ({{ compose }}) {
    newMessage();
    choices1.clearStore();
    var c_emails = [];
    choices1.setValue([
    {% for e in compose_to %}
        {value: '{{ e }}', label: '{{ e }}'},
    {% endfor %}
    ])
    $('#subject')[0].value = '{{ compose_subject }}';
    $('#body')[0].value = '{{ compose_body }}';
    $('#msg_pass')[0].value = '{{ compose_password }}';
}

if ({{ open_settings }}) {
    load_settings();
}

// -------- idk waht to do bout these stuff so u do it marcus lol ----START
function api(uri, data, callback) {
    $.ajax({
        url: '/api' + uri,
        type: 'post',
        data: JSON.stringify(data),
        headers: {
            token: token,
        },
        contentType: 'application/json',
        success: callback
    })
}
$( function() {
    api('/settings/forwards', {}, (addr) => {
        if (addr == 'none') {
            return
        }
        $('#forward')[0].value = addr;
    })
    $('#' + globalThis.theme).prop('selected', true);
})
function fastGet(start, end) {
    api('/v2/get', {
        'start': start,
        'end': end,
    }, (newEmails) => {
        globalThis.emails = Object.assign({}, globalThis.emails, newEmails);
    })
}
function newAPIKey() {
    api('/generate', {}, (key) => {
        $('#api_key')[0].value = key;
        refreshQRCode();
    })
}
function saveForward() {
    var addr = $('#forward')[0].value;

    if (addr == '') {
        addr = 'none';
    }

    api('/settings/forwards', {'email': addr}, (res) => {
        $.notify('Forward address changed to: ' + res, 'success');
    })
}// -------- idk waht to do bout these stuff so u do it marcus lol ----END

function saveTheme() {
    var darkmode = $('#switch')[0].checked;
    $('body').css({
        transition: 'all 0.5s'
    })

    if (darkmode) {
        setSetting('theme','dark');
        $("#dark").attr("media", "");
    }
    else {
        setSetting('theme','light');
        $("#dark").attr("media", "none");
    }
}
function saveStyle() {
    var style1 = $('#switch1')[0].checked;

    if (style1) {
        setSetting('style','classic');
    }
    else {
        setSetting('style','modern');
    }

    if (globalThis.emails != undefined) {
        needChange = true;
        makeEmails(globalThis.emails);
    }
}
function saveDateFormat() {
    var dateFormat1 = $('#switch2')[0].checked;

    if (dateFormat1) {
        setSetting('dateFormat','detailed');
    }
    else {
        setSetting('dateFormat','simple');
    }
}

</script>
{% endblock %}